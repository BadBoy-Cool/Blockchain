<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Debug ƒêƒÉng Nh·∫≠p</title>
    <style>
        /* ... [CSS c·ªßa b·∫°n gi·ªØ nguy√™n kh√¥ng ƒë·ªïi] ... */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 15px; padding: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .step { background: #f8f9ff; border-left: 5px solid #667eea; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .step h3 { margin-top: 0; color: #333; display: flex; align-items: center; gap: 10px; }
        .code-block { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; white-space: pre-wrap; margin: 10px 0; }
        .error { background: #fee; border-left: 5px solid #e53e3e; color: #742a2a; }
        .success { background: #f0fff4; border-left: 5px solid #38a169; color: #2f855a; }
        .warning { background: #fffbeb; border-left: 5px solid #d69e2e; color: #744210; }
        .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; margin: 10px 10px 10px 0; transition: transform 0.2s; }
        .btn:hover { transform: translateY(-2px); }
        .form-group { margin: 15px 0; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px; }
        .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #667eea; }
        .debug-output { background: #1a202c; color: #e2e8f0; padding: 15px; border-radius: 8px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; margin: 10px 0; }
        .emoji { font-size: 1.2em; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß C√¥ng c·ª• Debug ƒêƒÉng nh·∫≠p Payroll System</h1>
        
        <div class="step error">
            <h3><span class="emoji">‚ö†Ô∏è</span> V·∫•n ƒë·ªÅ ph√°t hi·ªán</h3>
            <p>C√≥ l·ªói trong qu√° tr√¨nh x√°c th·ª±c ch·ªØ k√Ω. C√≥ th·ªÉ do:</p>
            <ul>
                <li>Format message kh√¥ng kh·ªõp gi·ªØa client v√† server</li>
                <li>Public key ch∆∞a ƒë∆∞·ª£c l∆∞u ƒë√∫ng trong database</li>
                <li>Timestamp kh√¥ng h·ª£p l·ªá</li>
                <li>Ch·ªØ k√Ω kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng</li>
            </ul>
        </div>

        <div class="step">
            <h3><span class="emoji">1Ô∏è‚É£</span> Ki·ªÉm tra Database</h3>
            <p>ƒê·∫ßu ti√™n, h√£y ki·ªÉm tra xem user c·ªßa b·∫°n ƒë√£ c√≥ trong database ch∆∞a:</p>
            <div class="code-block">python check_database.py</div>
            
            <button class="btn" onclick="generateDatabaseCheck()">T·∫°o Script Ki·ªÉm tra DB</button>
            <div id="dbCheckScript" class="debug-output" style="display: none;"></div>
        </div>

        <div class="step">
            <h3><span class="emoji">2Ô∏è‚É£</span> T·∫°o User v√† Key m·ªõi</h3>
            <p>N·∫øu user ch∆∞a t·ªìn t·∫°i, t·∫°o user m·ªõi:</p>
            
            <div class="form-group">
                <label>Username:</label>
                <input type="text" id="newUsername" value="admin" placeholder="Nh·∫≠p t√™n user">
            </div>
            
            <button class="btn" onclick="generateUserCreation()">T·∫°o Script T·∫°o User</button>
            <div id="userCreationScript" class="debug-output" style="display: none;"></div>
        </div>

        <div class="step">
            <h3><span class="emoji">3Ô∏è‚É£</span> Test Signature</h3>
            <p>Ki·ªÉm tra xem vi·ªác t·∫°o ch·ªØ k√Ω c√≥ ho·∫°t ƒë·ªông ƒë√∫ng kh√¥ng:</p>
            
            <div class="form-group">
                <label>Username ƒë·ªÉ test:</label>
                <input type="text" id="testUsername" value="admin" placeholder="Nh·∫≠p username">
            </div>
            
            <button class="btn" onclick="generateSignatureTest()">T·∫°o Script Test Signature</button>
            <div id="signatureTestScript" class="debug-output" style="display: none;"></div>
        </div>

        <div class="step success">
            <h3><span class="emoji">4Ô∏è‚É£</span> H∆∞·ªõng d·∫´n th·ª±c hi·ªán</h3>
            <ol>
                <li><strong>Ch·∫°y script ki·ªÉm tra database:</strong> L∆∞u script ·ªü b∆∞·ªõc 1 th√†nh file <code>check_database.py</code> v√† ch·∫°y</li>
                <li><strong>T·∫°o user n·∫øu c·∫ßn:</strong> L∆∞u script ·ªü b∆∞·ªõc 2 th√†nh file <code>create_user.py</code> v√† ch·∫°y</li>
                <li><strong>Test signature:</strong> L∆∞u script ·ªü b∆∞·ªõc 3 th√†nh file <code>test_signature.py</code> v√† ch·∫°y</li>
                <li><strong>Copy k·∫øt qu·∫£:</strong> D√πng timestamp v√† signature t·ª´ script ƒë·ªÉ ƒëƒÉng nh·∫≠p</li>
            </ol>
        </div>

        <div class="step warning">
            <h3><span class="emoji">üîç</span> N·∫øu v·∫´n l·ªói</h3>
            <p>Ki·ªÉm tra c√°c v·∫•n ƒë·ªÅ sau trong code Flask:</p>
            <ul>
                <li><strong>AuthSystem.verify_user():</strong> ƒê·∫£m b·∫£o format message ƒë√∫ng</li>
                <li><strong>verify_signature():</strong> Ki·ªÉm tra function n√†y ho·∫°t ƒë·ªông</li>
                <li><strong>Database schema:</strong> ƒê·∫£m b·∫£o b·∫£ng users c√≥ ƒë√∫ng c·∫•u tr√∫c</li>
            </ul>
        </div>

        <div class="step">
            <h3><span class="emoji">üöÄ</span> Quick Fix</h3>
            <p>Th·ª≠ reset ho√†n to√†n h·ªá th·ªëng x√°c th·ª±c:</p>
            <button class="btn" onclick="generateQuickFix()">T·∫°o Script Reset System</button>
            <div id="quickFixScript" class="debug-output" style="display: none;"></div>
        </div>
    </div>

    <script>
        function generateDatabaseCheck() {
            const script = `import sqlite3
import json

def check_database():
    print("=== KI·ªÇM TRA DATABASE ===")
    
    conn = sqlite3.connect('payroll.db')
    c = conn.cursor()
    
    # Ki·ªÉm tra b·∫£ng users
    try:
        c.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='users'")
        if c.fetchone():
            print("‚úÖ B·∫£ng 'users' t·ªìn t·∫°i")
            
            c.execute("PRAGMA table_info(users)")
            columns = c.fetchall()
            print("üìã C·∫•u tr√∫c b·∫£ng users:")
            for col in columns:
                print(f"  - {col[1]} ({col[2]})")
            
            c.execute("SELECT id, username, role, is_active, employee_id FROM users")
            users = c.fetchall()
            print(f"\\nüë• C√≥ {len(users)} users:")
            for user in users:
                print(f"  - ID: {user[0]}, Username: {user[1]}, Role: {user[2]}, Active: {user[3]}, Employee_ID: {user[4]}")
                
        else:
            print("‚ùå B·∫£ng 'users' kh√¥ng t·ªìn t·∫°i")
            
    except Exception as e:
        print(f"‚ùå L·ªói ki·ªÉm tra: {e}")
    
    conn.close()

if __name__ == '__main__':
    check_database()`;
            
            document.getElementById('dbCheckScript').style.display = 'block';
            document.getElementById('dbCheckScript').textContent = script;
        }

        function generateUserCreation() {
            const username = document.getElementById('newUsername').value || 'admin';
            const script = `import sqlite3
import json
from cryptography.hazmat.primitives import serialization
from cryptography.hazmat.primitives.asymmetric import rsa

def create_user_with_keys(username):
    print(f"=== T·∫†O USER: {username} ===")
    
    # 1. T·∫°o RSA key pair
    private_key = rsa.generate_private_key(
        public_exponent=65537,
        key_size=2048
    )
    public_key = private_key.public_key()
    
    private_pem = private_key.private_bytes(
        encoding=serialization.Encoding.PEM,
        format=serialization.PrivateFormat.PKCS8,
        encryption_algorithm=serialization.NoEncryption()
    ).decode('utf-8')
    
    public_pem = public_key.public_bytes(
        encoding=serialization.Encoding.PEM,
        format=serialization.PublicFormat.SubjectPublicKeyInfo
    ).decode('utf-8')
    
    # 2. L∆∞u keys ra file
    filename = f"user_{username}_keys.json"
    with open(filename, 'w') as f:
        json.dump({
            "private_key": private_pem,
            "public_key": public_pem
        }, f)
    print(f"‚úÖ L∆∞u keys t·∫°i: {filename}")
    
    # 3. Th√™m user v√†o database
    conn = sqlite3.connect('payroll.db')
    c = conn.cursor()
    
    # X√≥a user c≈© n·∫øu c√≥
    c.execute("DELETE FROM users WHERE username = ?", (username,))
    
    # Th√™m user m·ªõi
    c.execute("""
        INSERT INTO users (username, public_key, role, is_active) 
        VALUES (?, ?, ?, ?)
    """, (username, public_pem, 'admin', 1))
    
    conn.commit()
    conn.close()
    
    print(f"‚úÖ T·∫°o user '{username}' th√†nh c√¥ng")
    print(f"üìÑ File keys: {filename}")
    print(f"üîë Public key preview: {public_pem[:50]}...")

if __name__ == '__main__':
    create_user_with_keys('${username}')`;
            
            document.getElementById('userCreationScript').style.display = 'block';
            document.getElementById('userCreationScript').textContent = script;
        }

        function generateSignatureTest() {
            const username = document.getElementById('testUsername').value || 'admin';
            const script = `import json
import time
import base64
import sqlite3
from cryptography.hazmat.primitives import hashes, serialization
from cryptography.hazmat.primitives.asymmetric import padding

def test_signature_flow(username):
    print(f"=== TEST SIGNATURE CHO USER: {username} ===")
    
    # 1. Load private key
    try:
        filename = f"user_{username}_keys.json"
        with open(filename, 'r') as f:
            keys = json.load(f)
            private_pem = keys['private_key']
            public_pem = keys['public_key']
        print("‚úÖ Load keys th√†nh c√¥ng")
    except Exception as e:
        print(f"‚ùå Kh√¥ng th·ªÉ load keys: {e}")
        return
    
    # 2. T·∫°o signature
    try:
        private_key = serialization.load_pem_private_key(
            private_pem.encode(),
            password=None,
        )
        
        timestamp = int(time.time())
        message = f"{timestamp}:{username}"
        
        signature = private_key.sign(
            message.encode(),
            padding.PSS(
                mgf=padding.MGF1(hashes.SHA256()),
                salt_length=padding.PSS.MAX_LENGTH
            ),
            hashes.SHA256()
        )
        signature_b64 = base64.b64encode(signature).decode()
        
        print(f"‚úÖ T·∫°o signature th√†nh c√¥ng")
        print(f"üìù Message: {message}")
        print(f"üî¢ Timestamp: {timestamp}")
        print(f"‚úçÔ∏è Signature: {signature_b64}")
        
    except Exception as e:
        print(f"‚ùå L·ªói t·∫°o signature: {e}")
        return
    
    # 3. Verify signature v·ªõi public key
    try:
        public_key = serialization.load_pem_public_key(public_pem.encode())
        
        public_key.verify(
            base64.b64decode(signature_b64),
            message.encode(),
            padding.PSS(
                mgf=padding.MGF1(hashes.SHA256()),
                salt_length=padding.PSS.MAX_LENGTH
            ),
            hashes.SHA256()
        )
        print("‚úÖ Verify signature th√†nh c√¥ng")
    except Exception as e:
        print(f"‚ùå Verify signature th·∫•t b·∫°i: {e}")
        return
    
    # 4. Ki·ªÉm tra user trong database
    try:
        conn = sqlite3.connect('payroll.db')
        c = conn.cursor()
        c.execute("SELECT id, username, public_key, role, is_active FROM users WHERE username = ?", (username,))
        user = c.fetchone()
        conn.close()
        
        if user:
            print(f"‚úÖ User t·ªìn t·∫°i trong DB: ID={user[0]}, Role={user[3]}, Active={user[4]}")
            db_public_key = user[2]
            if db_public_key == public_pem:
                print("‚úÖ Public key trong DB kh·ªõp v·ªõi file")
            else:
                print("‚ùå Public key trong DB KH√îNG kh·ªõp v·ªõi file")
                print(f"File key: {public_pem[:50]}...")
                print(f"DB key: {db_public_key[:50]}...")
        else:
            print("‚ùå User kh√¥ng t·ªìn t·∫°i trong DB")
    except Exception as e:
        print(f"‚ùå L·ªói ki·ªÉm tra DB: {e}")
    
    print("\\n=== TH√îNG TIN ƒêƒÇNG NH·∫¨P ===")
    print(f"Username: {username}")
    print(f"Timestamp: {timestamp}")
    print(f"Signature: {signature_b64}")

if __name__ == '__main__':
    test_signature_flow('${username}')`;
            
            document.getElementById('signatureTestScript').style.display = 'block';
            document.getElementById('signatureTestScript').textContent = script;
        }

        function generateQuickFix() {
            const script = `import sqlite3
import json
import os
from cryptography.hazmat.primitives import serialization
from cryptography.hazmat.primitives.asymmetric import rsa

def reset_auth_system():
    print("=== RESET HO√ÄN TO√ÄN H·ªÜ TH·ªêNG X√ÅC TH·ª∞C ===")
    
    # 1. Backup database c≈©
    if os.path.exists('payroll.db'):
        import shutil
        shutil.copy('payroll.db', 'payroll_backup.db')
        print("‚úÖ Backup database c≈©")
    
    # 2. T·∫°o l·∫°i b·∫£ng users
    conn = sqlite3.connect('payroll.db')
    c = conn.cursor()
    
    c.execute("DROP TABLE IF EXISTS users")
    c.execute('''CREATE TABLE users
                 (id INTEGER PRIMARY KEY,
                  username TEXT UNIQUE,
                  public_key TEXT,
                  role TEXT DEFAULT 'user',
                  last_login TIMESTAMP,
                  is_active BOOLEAN DEFAULT 1,
                  employee_id INTEGER)''')
    
    print("‚úÖ T·∫°o l·∫°i b·∫£ng users")
    
    # 3. T·∫°o user admin
    username = 'admin'
    
    # T·∫°o keys
    private_key = rsa.generate_private_key(
        public_exponent=65537,
        key_size=2048
    )
    public_key = private_key.public_key()
    
    private_pem = private_key.private_bytes(
        encoding=serialization.Encoding.PEM,
        format=serialization.PrivateFormat.PKCS8,
        encryption_algorithm=serialization.NoEncryption()
    ).decode('utf-8')
    
    public_pem = public_key.public_bytes(
        encoding=serialization.Encoding.PEM,
        format=serialization.PublicFormat.SubjectPublicKeyInfo
    ).decode('utf-8')
    
    # L∆∞u keys
    filename = f"user_{username}_keys.json"
    with open(filename, 'w') as f:
        json.dump({
            "private_key": private_pem,
            "public_key": public_pem
        }, f)
    
    # Th√™m v√†o DB
    c.execute("INSERT INTO users (username, public_key, role, is_active) VALUES (?, ?, ?, ?)",
              (username, public_pem, 'admin', 1))
    
    conn.commit()
    conn.close()
    
    print(f"‚úÖ T·∫°o user admin th√†nh c√¥ng")
    print(f"üìÑ Keys saved to: {filename}")
    
    # 4. Test signature ngay
    import time
    import base64
    from cryptography.hazmat.primitives import hashes
    from cryptography.hazmat.primitives.asymmetric import padding
    
    private_key_obj = serialization.load_pem_private_key(
        private_pem.encode(),
        password=None,
    )
    
    timestamp = int(time.time())
    message = f"{timestamp}:{username}"
    
    signature = private_key_obj.sign(
        message.encode(),
        padding.PSS(
            mgf=padding.MGF1(hashes.SHA256()),
            salt_length=padding.PSS.MAX_LENGTH
        ),
        hashes.SHA256()
    )
    signature_b64 = base64.b64encode(signature).decode()
    
    print("\\n=== S·ª¨ D·ª§NG ƒê·ªÇ ƒêƒÇNG NH·∫¨P ===")
    print(f"Username: {username}")
    print(f"Timestamp: {timestamp}")
    print(f"Signature: {signature_b64}")
    
    print("\\n‚úÖ RESET HO√ÄN T·∫§T!")

if __name__ == '__main__':
    reset_auth_system()`;
            
            document.getElementById('quickFixScript').style.display = 'block';
            document.getElementById('quickFixScript').textContent = script;
        }
    </script>
</body>
</html>